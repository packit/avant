services:
  redis:
    image: quay.io/sclorg/redis-6-c9s
    container_name: redis
    ports:
      - 6379:6379
    user: "1024"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres:
    container_name: postgres
    image: quay.io/sclorg/postgresql-15-c9s
    environment:
      POSTGRESQL_USER: packit
      POSTGRESQL_PASSWORD: secret-password
      POSTGRESQL_DATABASE: packit
    ports:
      - 5432:5432
    deploy:
      resources:
        limits:
          memory: 4GB
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U packit -d packit"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  avant:
    container_name: avant
    build:
      context: .
      dockerfile: files/Containerfile
      args:
        SOURCE_BRANCH: main

    image: quay.io/packit/avant:dev
    command: run_worker.sh
    depends_on:
      - redis
      - postgres
    ports:
      - 5678:5678
    environment:
      DEPLOYMENT: dev
      REDIS_SERVICE_HOST: redis
      APP: avant.worker.tasks
      POSTGRESQL_USER: packit
      POSTGRESQL_PASSWORD: secret-password
      POSTGRESQL_HOST: postgres
      POSTGRESQL_DATABASE: packit
      PUSHGATEWAY_ADDRESS: ""

    volumes:
      - ./avant:/src/avant:ro,z
      - ../ogr/ogr:/usr/local/lib/python3.14/site-packages/ogr:ro,z
      - ../packit/packit:/usr/local/lib/python3.14/site-packages/packit:ro,z
      - ../packit-service/packit_service:/usr/local/lib/python3.14/site-packages/packit_service:ro,z
      - ./secrets/packit/dev/packit-service.yaml:/home/packit/.config/packit-service.yaml:ro,z
      - ./secrets/packit/dev/copr:/home/packit/.config/copr:ro,z
      - ./secrets/packit/dev/ssh_config:/packit-ssh/config:ro,z
      - ./secrets/packit/dev/id_ed25519.pub:/packit-ssh/id_ed25519.pub:ro,z
      - ./secrets/packit/dev/id_ed25519:/packit-ssh/id_ed25519:ro,z
      - ./secrets/packit/dev/fedora.keytab:/secrets/fedora.keytab:ro,z
    user: "1024"

  service:
    container_name: service
    image: quay.io/packit/packit-service:dev
    userns_mode: "host"
    command: run_httpd.sh
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - 443:8443
    environment:
      DEPLOYMENT: dev
      REDIS_SERVICE_HOST: redis
      POSTGRESQL_USER: packit
      POSTGRESQL_PASSWORD: secret-password
      POSTGRESQL_HOST: postgres
      POSTGRESQL_DATABASE: packit
      FORGEJO_TOKEN: 829acbd418893cc05d5506706502b1b4a750d49a

    volumes:
      - ../packit/packit:/usr/local/lib/python3.14/site-packages/packit:ro,z
      - ../packit-service/packit_service:/usr/local/lib/python3.14/site-packages/packit_service:ro,z
      - ../packit-service/alembic:/src/alembic:ro,z
      - ./secrets/packit/dev/packit-service.yaml:/home/packit/.config/packit-service.yaml:ro,z
      - ./secrets/packit/dev/fullchain.pem:/secrets/fullchain.pem:ro,z
      - ./secrets/packit/dev/privkey.pem:/secrets/privkey.pem:ro,z
    user: "1024"

  fedora-messaging:
    container_name: fedora-messaging
    image: quay.io/packit/packit-service-fedmsg:stg
    depends_on:
      redis:
        condition: service_healthy
    environment:
      DEPLOYMENT: dev
      FEDORA_MESSAGING_CONF: /home/packit/.config/fedora.toml
      REDIS_SERVICE_HOST: redis
    volumes:
      - ./secrets/packit/dev/fedora.toml:/home/packit/.config/fedora.toml:ro
    user: "1024"
